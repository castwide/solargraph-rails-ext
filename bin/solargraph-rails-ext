#!/usr/bin/env ruby

require 'solargraph-rails-ext'

rails_config = File.join(Dir.pwd, 'config', 'application.rb')
if File.file?(rails_config)
  require_relative(rails_config)
end

def find_constant(namespace, root)
  result = nil
  parts = root.split('::')
  until parts.empty?
    result = inner_find_constant("#{parts.join('::')}::#{namespace}")
    parts.pop
    break unless result.nil?
  end
  result = inner_find_constant(namespace) if result.nil?
  result
end

def inner_find_constant(namespace)
  cursor = Object
  parts = namespace.split('::')
  until parts.empty?
    here = parts.shift
    begin
      cursor = cursor.const_get(here)
    rescue NameError
      return nil
    end
  end
  cursor
end


while true
  input = gets
  args = JSON.parse(input)
  result = []
  con = find_constant(args['namespace'], args['root'])
  unless con.nil?
    if (args['scope'] == 'class')
      if args['with_private']
        result.concat con.methods
      else
        result.concat con.public_methods
      end
    elsif (args['scope'] == 'instance')
      if args['with_private']
        result.concat con.instance_methods
      else
        result.concat con.public_instance_methods
      end
    end
  end
  STDOUT.puts "#{result.to_json}"
  STDOUT.flush
end
